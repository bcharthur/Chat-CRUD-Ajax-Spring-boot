<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Student Management</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.2/cosmo/bootstrap.min.css" />
    <link href="https://cdn.datatables.net/v/dt/dt-2.0.8/datatables.min.css" rel="stylesheet">

    <!-- Load jQuery from CDN -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- Load jQuery Validate from CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-validate/1.19.2/jquery.validate.min.js"></script>
    <!-- Load Bootstrap JavaScript from CDN -->
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <!-- Load DataTables from CDN -->
    <script src="https://cdn.datatables.net/v/dt/dt-2.0.8/datatables.min.js"></script>
    <!-- Load SockJS and Stomp -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

    <style>
        .navbar-custom {
            background-color: #343a40;
        }
        .navbar-custom .navbar-brand,
        .navbar-custom .navbar-text {
            color: #ffffff;
        }
        .panel-body {
            margin-top: 20px;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-custom navbar-expand-lg">
    <a class="navbar-brand" href="#">Student Management</a>
</nav>

<div class="container mt-4">
    <div class="row">
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Student Form
                </div>
                <div class="card-body">
                    <form id="frmStudent" name="frmStudent">
                        <div class="form-group">
                            <label for="studentname">Student Name</label>
                            <input type="text" id="studentname" name="studentname" placeholder="Student Name" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="course">Course</label>
                            <input type="text" id="course" name="course" placeholder="Course" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="fee">Fee</label>
                            <input type="text" id="fee" name="fee" placeholder="Fee" class="form-control" required>
                        </div>
                        <div class="form-group text-center">
                            <button type="button" class="btn btn-success" id="save" onclick="addStudent()">Add</button>
                            <button type="button" class="btn btn-warning" id="update" onclick="updateStudent()">Update</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    Student List
                </div>
                <div class="card-body">
                    <table id="tbl-student" class="table table-striped table-bordered" width="100%">
                        <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Course</th>
                            <th>Fee</th>
                            <th>Edit</th>
                            <th>Delete</th>
                        </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var stompClient = null;
    var isNew = true;
    var studid = null;
    var studentTable = null;

    function connect() {
        var socket = new SockJS('/gs-guide-websocket');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // Disable Stomp logging
        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/topic/students', function (message) {
                updateTable(JSON.parse(message.body));
            });
        });
    }

    function disconnect() {
        if (stompClient !== null) {
            stompClient.disconnect();
        }
    }

    function updateTable(students) {
        if (studentTable) {
            studentTable.clear().rows.add(students).draw();
        }
    }

    $(document).ready(function () {
        connect();
        initializeTable();
        getall();
    });

    function initializeTable() {
        studentTable = $('#tbl-student').DataTable({
            "columns": [
                { data: 'studentname' },
                { data: 'course' },
                { data: 'fee' },
                {
                    data: null,
                    render: function (data, type, full, meta) {
                        return '<button class="btn btn-success btn-sm" onclick="get_details(' + data.id + ')">Edit</button>';
                    }
                },
                {
                    data: null,
                    render: function (data, type, full, meta) {
                        return '<button class="btn btn-danger btn-sm" onclick="get_Delete(' + data.id + ')">Delete</button>';
                    }
                }
            ]
        });
    }

    function addStudent() {
        if ($("#frmStudent").valid()) {
            var url = "";
            var data = "";
            var method;

            if (isNew == true) {
                url = '[[${@environment.getProperty('api.base.path')}]]/Student/save';
                data = $("#frmStudent").serialize();
                method = 'POST';
            }

            $.ajax({
                type: method,
                url: url,
                dataType: "JSON",
                data: data,
                success: function (data) {
                    $('#studentname').val("");
                    $('#course').val("");
                    $('#fee').val("");
                    getall();
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                    alert("An error occurred: " + xhr.responseText);
                }
            });
        }
    }

    function updateStudent() {
        if ($("#frmStudent").valid()) {
            var url = "";
            var data = "";
            var method;

            if (isNew == false) {
                url = '[[${@environment.getProperty('api.base.path')}]]/Student/edit/' + studid;
                data = $("#frmStudent").serialize();
                method = 'POST';
            }

            $.ajax({
                type: method,
                url: url,
                dataType: "JSON",
                data: data,
                success: function (data) {
                    $('#studentname').val("");
                    $('#course').val("");
                    $('#fee').val("");
                    getall();
                },
                error: function (xhr, status, error) {
                    console.log(xhr.responseText);
                    alert("An error occurred: " + xhr.responseText);
                }
            });
        }
    }

    function getall() {
        $.ajax({
            url: "[[${@environment.getProperty('api.base.path')}]]/Student/list",
            type: "GET",
            dataType: "JSON",
            success: function (data) {
                updateTable(data);
            }
        });
    }

    function get_details(id) {
        $.ajax({
            type: "POST",
            url: "[[${@environment.getProperty('api.base.path')}]]/Student/get/" + id,
            success: function (data) {
                isNew = false;
                studid = data.id;
                $('#studentname').val(data.studentname);
                $('#course').val(data.course);
                $('#fee').val(data.fee);
            }
        });
    }

    function get_Delete(id) {
        $.ajax({
            type: "POST",
            url: "[[${@environment.getProperty('api.base.path')}]]/Student/delete/" + id,
            dataType: "JSON",
            success: function (data) {
                $('#studentname').val("");
                $('#course').val("");
                $('#fee').val("");
                getall();
            }
        });
    }
</script>

</body>
</html>
